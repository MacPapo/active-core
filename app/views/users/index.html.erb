<div class="d-flex justify-content-between align-items-center mb-3">
    <p class="mb-0 fs-3 fw-semibold text-secondary">
        <%= model_to_string(User, 2) %>
    </p>

    <div class="d-flex align-items-center">
        <% count = User.count %>
        <p class="fs-3 fw-bold text-secondary mb-0"><%= count %></p>
        <span class="fs-6 fw-light ps-2 text-muted"><%= t('global.registered', count:) %></span>
    </div>
</div>

<div class="bg-primary border border-secondary-subtle rounded-3 container-fluid">
    <div class="d-flex align-items-center">
        <div class="flex-fill">

            <!-- Search form -->
            <%= render 'partials/search_form', loc: t('global.search_name'), path: users_path, frame: :users, size: '500px', ctrls: 'filters' do |f| %>
                <div class="row mb-2">
                    <!-- Membership Status -->
                    <div class="col">
                        <%= f.label :membership_status, t('global.membership_status'), class: 'form-label fw-semibold text-secondary' %>
                        <%= f.select :membership_status, Subscription.humanize_statuses, { prompt: t('global.all-m') },
                         class: 'form-select', data: { action: 'change->filters#submit' } %>
                    </div>
                </div>

                <div class="row g-2 mb-2">
                    <!-- Activity Status -->
                    <div class="col">
                        <%= f.label :activity_status, t('global.activity_status'), class: 'form-label fw-semibold text-secondary' %>
                        <%= f.select :activity_status, Subscription.humanize_statuses, { prompt: t('global.all-m') },
                         class: 'form-select', data: { action: 'change->filters#submit' } %>
                    </div>

                    <!-- Activity ID -->
                    <div class="col">
                        <%= f.label :activity_id, t('global.activity_name'), class: 'form-label fw-semibold text-secondary' %>
                        <%= f.select :activity_id, Activity.pluck(:name, :id), { prompt: t('global.all-s') },
                         class: 'form-select', data: { action: 'change->filters#submit' } %>
                    </div>
                </div>

		<div class="row mb-2">
                    <!-- Visibility -->
		    <div class="col">
			<%= f.label :visibility, t('global.user_visibility'), class: 'form-label fw-semibold text-secondary' %>
			<%= f.select :visibility, [[t('global.all-m'), 'all'], [t('global.invisible'), 'deleted']], { prompt: t('global.visible') },
			 class: 'form-select', data: { action: 'change->filters#submit' } %>
		    </div>
		</div>
            <% end %>
        </div>

        <!-- Add User -->
        <%= link_to new_user_path, class: 'btn btn-dark text-secondary border border-secondary-subtle ms-2' do %>
            <i class="bi bi-person-fill-add"></i>
            <span class="ms-1"><%= t '.add_user' %></span>
        <% end %>
    </div>

    <%= turbo_frame_tag :users do %>
        <% user_sortable_column = ->(col, title) { sortable_column(col, title, users_path, :users, @sort_by, @direction) } %>
        <div id="users" class="table-responsive">
            <div class="rounded-3 border border-secondary-subtle overflow-hidden mb-3">
                <table class="table table-borderless table-striped mb-0">
                    <thead class="table-secondary">
                        <tr class="fs-6">
                            <th class="text-primary text-begin fw-semibold"><%= t 'global.table.status' %></th>
                            <th><%= user_sortable_column.call('name', User.human_attribute_name('name')) %></th>
                            <th><%= user_sortable_column.call('surname', User.human_attribute_name('surname')) %></th>
                            <th><%= user_sortable_column.call('birth_day', User.human_attribute_name('birth_day')) %></th>
                            <th class="text-primary fw-semibold"><%= User.human_attribute_name('membership') %></th>
                            <th class="text-primary fw-semibold"><%= User.human_attribute_name('activity') %></th>
                            <th class="text-primary text-end fw-semibold"><%= t 'global.table.action' %></th>
                        </tr>
                    </thead>
                    <tbody>
                        <% @users.each do |user| %>
                            <tr class="align-middle">
                                <td class="text-begin">
                                    <% compliance = user.verify_compliance %>
                                    <% count = compliance&.size %>
                                    <% is_compliance = compliance.empty? %>
                                    <div
                                        data-controller="popover"
                                        data-popover-title="<%= t('.popover', count: count) %>"
                                        data-popover-content="<%= compliance.join(", ") %>"
                                    >
                                        <span
                                            data-popover-target="button"
                                            class="btn border border-secondary-subtle badge rounded-pill text-bg-<%= is_compliance ? 'success' : 'warning' %>"
                                        >
                                            <i class="text-secondary bi bi-person-fill-<%= is_compliance ? 'check' : 'exclamation' %>"></i>
                                        </span>
                                    </div>
                                </td>

                                <!-- Name -->
                                <td>
                                    <%= highlight user.name, params.dig(:name) %>
                                </td>

                                <!-- Surname -->
                                <td>
                                    <%= highlight user.surname, params.dig(:name) %>
                                </td>

                                <!-- Birth Day -->
                                <td>
                                    <%= user.birth_day ? l(user.birth_day, format: :default) : nil %>
                                </td>

                                <!-- Membership -->
                                <td>
                                    <% presenter = MembershipPresenter.new(user.membership) %>
                                    <%= link_to presenter.appropriate_path(user),
						method: presenter.method,
						class: "btn btn-#{presenter.css_color} text-secondary border border-secondary-subtle badge rounded-pill",
						data: { turbo_method: presenter.method, turbo_frame: "_top" } do %>
                                        <i class="<%= presenter.link_icon %>"></i>
                                        <%= presenter.link_title %>
                                    <% end %>
                                </td>

                                <!-- Activities -->
                                <td>
                                    <% subs = user.subscriptions.kept.where.missing(:normal_subscription) %>
                                    <% subs.each do |sub| %>
                                        <% presenter = SubscriptionPresenter.new(sub) %>
                                        <%= link_to presenter.appropriate_path(user),
						    method: presenter.method,
						    class: "btn btn-#{ presenter.css_color } text-secondary border border-secondary-subtle badge rounded-pill",
						    data: { turbo_method: presenter.method, turbo_frame: "_top" } do %>
                                            <i class="<%= presenter.link_icon %>"></i> <%= presenter.link_title %>
                                        <% end %>
                                    <% end %>
                                </td>

                                <!-- Action buttons -->
                                <td class="text-end">
                                    <%= link_to user, class: 'btn btn-view btn-sm border border-secondary-subtle', data: { turbo_frame: "_top" } do %>
                                        <i class="bi text-secondary bi-eye-fill"></i>
                                    <% end %>

                                    <%= link_to edit_user_path(user), class: 'btn btn-edit btn-sm border border-secondary-subtle', data: { turbo_frame: "_top" } do %>
                                        <i class="bi text-secondary bi-pencil-fill"></i>
                                    <% end %>

				    <% if user.discarded? %>
					<%= button_to restore_user_path(user),
						      class: 'btn btn-restore btn-sm border border-secondary-subtle',
						      method: :patch,
						      data: { turbo_confirm: t('global.restore_dialog'), turbo_frame: "_top" },
						      form: {style: 'display:inline-block;'} do %>
					    <i class="bi bi-recycle"></i>
					<% end %>
				    <% else %>
					<%= button_to user_path(user),
                                                      class: 'btn btn-delete text-secondary btn-sm border border-secondary-subtle',
                                                      method: :delete,
                                                      data: { turbo_confirm: t('global.delete_dialog'), turbo_frame: "_top" },
                                                      form: {style: 'display:inline-block;'} do %>
                                            <i class="bi bi-trash3-fill"></i>
					<% end %>
				    <% end %>
                                </td>
                            </tr>
                        <% end %>
                    </tbody>
                </table>
            </div>

            <%== pagy_bootstrap_nav(@pagy) %>
        </div>
    <% end %>
</div>
